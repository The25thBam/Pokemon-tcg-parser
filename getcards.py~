#/usr/bin/python3
from bs4 import BeautifulSoup as bsp
from platform import system as OSdetect
from os import system
from requests import Session
from wget import download

def prepareToParse(link):
    req = Session()
    html = req.get(link, cookies={"display":"images"})
    soup = bsp(html.text, "html5lib")
    return soup

def getExpansionTitle(to_parse):
    for h1 in to_parse.find_all("h1"):
        e_title = str(h1)
        e_title = e_title[27::]
        e_title = e_title[0:-15]
        return e_title

def shellScriptDetect():
    if OSdetect() == "Windows":
        return "Batch"
    else:
        return "Bash"

def fixPath(path):
    if shellScriptDetect() == "Batch":
        path=path.replace("/", "\\")
    return path

def createFolder(directory):
    system(f"mkdir \"{directory}\"")

def getCardNames(to_parse):
    names = []
    for img in to_parse.find_all("img"):
        name = str(img["alt"])
        name = name.split()
        number = name[-1].split("/")[0].zfill(3)
        name = " ".join(name).split("(")[0][:-1]
        name = f"{number} {name}"
        names.append(name)
    return names

def getCardURLs(to_parse):
    card_URLs=[]
    for img in to_parse.find_all("img"):
        card_URL = img["src"]
        card_URLs.append(card_URL)
    return card_URLs

def getOldNames(links):
    old_names=[]
    for link in links:
        name=link.split("/")[-1]
        old_names.append(old_names)

def getCards(expansionSoup, path):
    card_URLs = getCardURLs(expansionSoup)
    old_card_names = getOldNames(card_URLs)
    new_card_names = getCardNames(expansionSoup)
    for URL in card_URLs:
        download(URL, out=path, bar=None)
    
if __name__ == "__main__":
    createFolder("Pokemon")
    for expansion in range(1, 156):
        url = f"https://www.tcgcollector.com/cards?expansion-{expansion}=on"
        website = prepareToParse(url)
        expansion_title = getExpansionTitle(website)
        folder_path = (f"Pokemon/{str(expansion).zfill(3)} {expansion_title}")
        folder_path = fixPath(folder_path)
        createFolder(folderPath)
        getCards(website, expansion_title)
        break

